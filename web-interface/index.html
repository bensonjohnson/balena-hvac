<!DOCTYPE html>
<html>
<head>
    <title>Thermostat Control Panel</title>
    <meta charset="UTF-8">
    <!-- Link to your external CSS file -->
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <!-- Temperature Display Section -->
    <div id="tempDisplay">
        <h1>Current Temperature</h1>
        <p>Temperature: <span id="current-temperature">--</span>Â°F</p>
        <p>Humidity: <span id="current-humidity">--</span>%</p>
        <p>System State: <span id="system-state">--</span></p>
    </div>

    <!-- Temperature Set Control Section -->
    <div id="tempSetControl">
        <h1>Set Temperature</h1>
        <form id="set-temp-form">
            <input type="number" id="settemp" name="settemp" step="0.1" required placeholder="Enter temperature">
            <input type="submit" value="Set Temperature">
        </form>
    </div>

    <!-- Control Panel Section -->
    <div id="controlPanel">
        <h1>System Control</h1>
        <label class="switch">
            <input type="checkbox" id="system-toggle" checked>
            <span class="slider"></span>
        </label>
        <p>Toggle System On/Off</p>
    </div>

    <!-- Sensor Control Section -->
    <div id="sensorControl">
        <h1>Select Sensor Mode</h1>
        <select id="sensor-select">
            <option value="average">Average</option>
            <!-- Sensor options will be populated dynamically -->
        </select>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="status-message"></div>

    <!-- Include JavaScript -->
    <script>
        // URL of your Flask API
        const apiUrl = 'http://your-api-url'; // Replace with your actual API base URL

        // Function to update the current status
        function updateStatus() {
            fetch(`${apiUrl}/getstatus`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current-temperature').textContent = data.average_temperature.toFixed(1);
                    document.getElementById('current-humidity').textContent = data.average_humidity.toFixed(1);
                    document.getElementById('system-state').textContent = data.systemState;
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        // Event listener for the set temperature form
        document.getElementById('set-temp-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const settempInput = document.getElementById('settemp');
            const newTemp = parseFloat(settempInput.value);

            if (isNaN(newTemp)) {
                displayStatusMessage('Please enter a valid temperature.', true);
                return;
            }

            fetch(`${apiUrl}/settemp`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ settemp: newTemp })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'An error occurred while setting the temperature.');
                    });
                }
                return response.json();
            })
            .then(responseData => {
                displayStatusMessage(responseData.message, false);
                settempInput.value = '';
                updateStatus(); // Update the status after setting the temperature
            })
            .catch(error => {
                displayStatusMessage(error.message, true);
            });
        });

        // Event listener for the system toggle switch
        document.getElementById('system-toggle').addEventListener('change', function(event) {
            const state = this.checked ? 'on' : 'off';

            fetch(`${apiUrl}/toggle_system`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ state: state })
            })
            .then(response => response.json())
            .then(data => {
                displayStatusMessage(data.message, false);
                updateStatus();
            })
            .catch(error => {
                displayStatusMessage('Error toggling system: ' + error.message, true);
            });
        });

        // Function to populate the sensor select options
        function populateSensorOptions() {
            fetch(`${apiUrl}/getstatus`)
                .then(response => response.json())
                .then(data => {
                    const sensorSelect = document.getElementById('sensor-select');
                    // Clear existing options except 'Average'
                    sensorSelect.innerHTML = '<option value="average">Average</option>';

                    const sensors = Object.keys(data.sensorData);
                    sensors.forEach(sensor => {
                        const option = document.createElement('option');
                        option.value = sensor;
                        option.textContent = sensor;
                        sensorSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching sensors:', error);
                });
        }

        // Event listener for the sensor mode select
        document.getElementById('sensor-select').addEventListener('change', function(event) {
            const mode = this.value === 'average' ? 'average' : 'specific';
            const sensor_name = this.value !== 'average' ? this.value : null;

            fetch(`${apiUrl}/set_mode`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mode: mode, sensor_name: sensor_name })
            })
            .then(response => response.json())
            .then(data => {
                displayStatusMessage(data.message, false);
                updateStatus();
            })
            .catch(error => {
                displayStatusMessage('Error setting mode: ' + error.message, true);
            });
        });

        // Function to display status messages
        function displayStatusMessage(message, isError) {
            const statusMessageDiv = document.getElementById('status-message');
            statusMessageDiv.textContent = message;
            statusMessageDiv.style.color = isError ? 'red' : 'green';
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            populateSensorOptions();
            // Refresh the status every 60 seconds
            setInterval(updateStatus, 60000);
        });
    </script>
</body>
</html>
